## Chapter 3 - SERVICE CREATION
> Designed! Congratz! :boom:  
> Time to make it real! Let's create our ACL_SERVICE! :construction_worker:

### 1st step - Generate skeleton of the service:
Let's first generate skeleton of our ACL_SERVICE and take a look on its structure.  
Navigate to the `packages` folder inside `/opt/ncs-run`:
```
root@ad720ce13193:/opt/ncs-run# cd packages/
```
Generate a skeleton of our `ACL_SERVICE`:
```
root@ad720ce13193:/opt/ncs-run/packages# ncs-make-package --service-skeleton python-and-template ACL_SERVICE
```
Created! Go inside our package and check what's inside:
```
root@ad720ce13193:/opt/ncs-run/packages# cd ACL_SERVICE
root@ad720ce13193:/opt/ncs-run/packages/ACL_SERVICE# ls
README  package-meta-data.xml  python  src  templates  test
```
Generated structure looks following:
<img src="/readme/package.png"></img>

We're going to take care of:  
- <b>XML TEMPLATE</b> - /template/ACL_SERVICE-template.xml  
- <b>YANG DATA MODEL</b> - /src/yang/ACL_SERVICE.yang    
- <b>PYTHON LOGIC</b> (optional) - /python/ACL_SERVICE/main.py  


### 2nd step - Create XML TEMPLATE

First part is an XML template of our Service - this will be an actual config pushed to the device.
<img src="/readme/temp.png"></img>

This is an XML template generated by default: <br>
<p align="center">
<img width=460 src="/readme/xml_init.png"></img>
</p>

Log in back to NSO:
```
ncs_cli -C -u admin
```

Put sample config on NSO and generate XML from it.

First for IOS device:
```
devices device IOS0 config ios:ip access-list standard ACL_CLUS
permit 172.16.0.0 0.0.255.255
deny 192.168.34.0 0.0.0.255

devices device IOS0 config ios:interface GigabitEthernet 0/0
ip access-group ACL_CLUS in
```


```
commit dry-run outformat xml
```

<img src="init temp.png"></img>

We only wanted to generate the structure of XML. Don't commit that configuration, abort it:
```
admin@ncs(config-if)# abort
```

Go back to the config mode:
```
admin@ncs# config
```

And repeat all steps for IOS-XR:
```
devices device IOS_XR0 config cisco-ios-xr:ipv4 access-list ACL_CLUS
10 permit 172.16.0.0 0.0.255.255
20 deny 192.168.34.0 0.0.0.255

devices device IOS_XR0 config cisco-ios-xr:interface GigabitEthernet 0/0
ipv4 access-group ACL_CLUS ingress
```

As well as Juniper:
```
...
...
...
set interface xe-0/2/0/2 unit 0 family inet filter input ACL_CLUS
```

Once you're done - the complete template **ACL_SERVICE-template.xml** should looks like that:
<p align="center">
<img width=640 src="/readme/template_full.png"></img>
</p>

Congratz! You have prepared all devices configuration! But it's now fixed. Let's put here our **variables** from the previous Chapter!

Parameter | IOS  | IOS-XR | Juniper
------------ | ------------- | ------------- | -------------
interface | GigabitEthernet `[int_number]` | GigabitEthernet `[int_number]` | `[int]`
direction | `[in/out]` | `[in/out]` | `[input/output]`  

IOS:
<img src="/readme/iosparam.png"></img>

IOS-XR:
<img src="/readme/xrparam.png"></img>

JUNIPER:
<img src="/readme/junparam.png"></img>


### 3rd step - Create YANG DATA MODEL

Second part is a YANG Data Model of our Service - this will give us an opportunity to provide the CLI interface to configure our Service exactly in that way that we want to have. 
<img src="/readme/yang.png"></img>


Hmmm... what was our Service design from the previous Chapter?
```
service ACL_SERVICE [device] [interface] [in|out]
```

Let's model it in YANG! <br>
This is our generated YANG Skeleton:
<img src="/readme/yangxml.png"></img>

Let's make some changes:
```
module ACL_SERVICE {

  namespace "http://example.com/ACL_SERVICE";
  prefix ACL_SERVICE;

  import ietf-inet-types {
    prefix inet;
  }
  import tailf-common {
    prefix tailf;
  }
  import tailf-ncs {
    prefix ncs;
  }
  import tailf-ned-cisco-ios {
    prefix ios;
  }
  import tailf-ned-cisco-ios-xr {
    prefix iosxr;
  }
  import junos {
    prefix junos;
  }

  description
    "Bla bla...";

  revision 2016-01-01 {
    description
      "Initial revision.";
  }

  list ACL_SERVICE {
    description "This is an RFS skeleton service";

    key "device";
    uses ncs:service-data;
    ncs:servicepoint ACL_SERVICE-servicepoint;

    leaf device {
      type leafref {
        path "/ncs:devices/ncs:device/ncs:name";
      }
    }

    container ios {
        tailf:cli-drop-node-name;
        when "(contains(deref(../device)/../ncs:platform/ncs:name, 'ios'))" {
        tailf:dependency "../device";
        }
        leaf interface {
        type leafref {
          path "deref(../../device)/../ncs:config/ios:interface/ios:GigabitEthernet/ios:name";
          }
        }
        leaf direction {
          type enumeration { 
            enum in; 
            enum out; 
          }
        }
    }

      container xr {
        tailf:cli-drop-node-name;
        when "(contains(deref(../device)/../ncs:platform/ncs:name, 'ios-xr'))" {
        tailf:dependency "../device";
        }
        leaf interface {
        type leafref {
          path "deref(../../device)/../ncs:config/iosxr:interface/iosxr:GigabitEthernet/iosxr:id";
          }
        }
        leaf direction {
          type enumeration { 
            enum in; 
            enum out; 
          }
        }
      }

      container junos {
        tailf:cli-drop-node-name;
        when "(contains(deref(../device)/../ncs:platform/ncs:name, 'junos'))" {
        tailf:dependency "../device";
        }
        leaf interface {
        type leafref {
          path "deref(../../device)/../ncs:config/junos:configuration/junos:interfaces/junos:interface/junos:name";
          }
        }
        leaf direction {
          type enumeration { 
            enum input; 
            enum output; 
          }
        }
      }

  }
}
```

After creation of the model, go back to the ACL_SERVICE folder and compile the package executing command:
```
make clean all
```

### 4th step - Create PYTHON LOGIC (optional)

Third part is a Python code of our Service - this will give us an opportunity to provide logic to our Service if we need to calculate something before appending to the template or provide some data to configure from 3rd party.

<img src="/readme/python.png"></img>

---
<h4 align="center">[6/9]</h4>
<h4 align="center"> <a href="/readme/4.md"> :arrow_left: Design the Service! </a> || <a href="/readme/6.md"> Deploy the Service! :arrow_right: </a> </h4>
