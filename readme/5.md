## Chapter 3 - SERVICE CREATION
> Designed! Congratz! :boom:  
> Time to make it real! Let's create our ACL_SERVICE! :construction_worker:

### 1st step - Generate skeleton of the service:
Let's first generate skeleton of our ACL_SERVICE and take a look on its structure.  
Navigate to the `packages` folder:
```
root@ad720ce13193:/opt/ncs-run# cd packages/
```
Generate a skeleton of our `ACL_SERVICE`:
```
root@ad720ce13193:/opt/ncs-run/packages# ncs-make-package --service-skeleton python-and-template ACL_SERVICE
```
Created! Go inside our package and check what's inside:
```
root@ad720ce13193:/opt/ncs-run/packages# cd ACL_SERVICE
root@ad720ce13193:/opt/ncs-run/packages/ACL_SERVICE# ls
README  package-meta-data.xml  python  src  templates  test
```
Generated structure looks following:
<img src="/readme/package.png"></img>
```
/ncs-run/packages
├── ACL_SERVICE
│   ├── templates
│   │   └── ACL_SERVICE-template.xml
│   ├── src
│   │   ├── yang
│   │   │   └── ACL_SERVICE.yang
│   │   └── Makefile
│   ├── python
│   │   └── ACL_SERVICE
│   │   │   ├── main.py
│   │   │   └── __init__.py
│   ├── test
│   ├── package-meta-data.xml
│   └── README
└── OTHER_SERVICE
```
We're going to take care of:  
- <b>XML TEMPLATE</b> - /template/ACL_SERVICE-template.xml  
- <b>YANG DATA MODEL</b> - /src/yang/ACL_SERVICE.yang    
- <b>PYTHON LOGIC</b> (optional) - /python/ACL_SERVICE/main.py  

<img src="/readme/yangxml.png"></img>

### 2nd step - Create XML TEMPLATE

First part is an XML template of our Service - this will be an actual config pushed to the device.
```
/ncs-run/packages
├── ACL_SERVICE
    └── templates
        └── ACL_SERVICE-template.xml
```

This is an XML template generated by default: <br>
<p align="center">
<img width=460 src="/readme/xml_init.png"></img>
</p>
                                         
Put sample config on NSO and generate XML from it.
First for IOS:
```
devices device IOS0 config ios:ip access-list standard ACL_CLUS
permit 172.16.0.0 0.0.255.255
deny 192.168.34.0 0.0.0.255

devices device IOS0 config ios:interface GigabitEthernet 0/0
ip access-group ACL_CLUS in
```
DRY RUN:
```
admin@ncs(config-if)# commit dry-run outformat xml
result-xml {
    local-node {
        data <devices xmlns="http://tail-f.com/ns/ncs">
               <device>
                 <name>IOS0</name>
                 <config>
                   <ip xmlns="urn:ios">
                     <access-list>
                       <standard>
                         <std-named-acl>
                           <name>ACL_CLUS</name>
                           <std-access-list-rule>
                             <rule>permit 172.16.0.0 0.0.255.255</rule>
                           </std-access-list-rule>
                           <std-access-list-rule>
                             <rule>deny 192.168.34.0 0.0.0.255</rule>
                           </std-access-list-rule>
                         </std-named-acl>
                       </standard>
                     </access-list>
                   </ip>
                   <interface xmlns="urn:ios">
                     <GigabitEthernet>
                       <name>0/0</name>
                       <ip>
                         <access-group>
                           <direction>in</direction>
                           <access-list>ACL_CLUS</access-list>
                         </access-group>
                       </ip>
                     </GigabitEthernet>
                   </interface>
                 </config>
               </device>
             </devices>
    }
}
```

```
admin@ncs(config-if)# abort
admin@ncs# config
```

Repeat all steps for IOS-XR:
```
devices device IOS_XR0 config cisco-ios-xr:ipv4 access-list ACL_CLUS
10 permit 172.16.0.0 0.0.255.255
20 deny 192.168.34.0 0.0.0.255

devices device IOS_XR0 config cisco-ios-xr:interface GigabitEthernet 0/0
ipv4 access-group ACL_CLUS ingress
```

And same steps Juniper:
```
...
...
...
set interface xe-0/2/0/2 unit 0 family inet filter input ACL_CLUS
```  

```
<config-template xmlns="http://tail-f.com/ns/config/1.0">
  <devices xmlns="http://tail-f.com/ns/ncs">
    <device>
      <!--
          Select the devices from some data structure in the service
          model. In this skeleton the devices are specified in a leaf-list.
          Select all devices in that leaf-list:
        -->
        <name>{/device}</name>
        <config>
         <ip xmlns="urn:ios">
           <access-list>
             <standard>
               <std-named-acl>
                 <name>ACL_CLUS</name>
                 <std-access-list-rule>
                   <rule>permit 172.16.0.0 0.0.255.255</rule>
                 </std-access-list-rule>
                 <std-access-list-rule>
                   <rule>deny 192.168.34.0 0.0.0.255</rule>
                 </std-access-list-rule>
               </std-named-acl>
             </standard>
           </access-list>
         </ip>
         <interface xmlns="urn:ios">
           <GigabitEthernet>
             <name>0/0</name>
             <ip>
               <access-group>
                 <direction>in</direction>
                 <access-list>ACL_CLUS</access-list>
               </access-group>
             </ip>
           </GigabitEthernet>
         </interface>

         <ipv4 xmlns="http://tail-f.com/ned/cisco-ios-xr">
           <access-list>
             <named-acl>
               <name>ACL_CLUS</name>
               <rule>
                 <id>10</id>
                 <line>permit 172.16.0.0 0.0.255.255</line>
               </rule>
               <rule>
                 <id>20</id>
                 <line>deny 192.168.34.0 0.0.0.255</line>
               </rule>
             </named-acl>
           </access-list>
         </ipv4>
         <interface xmlns="http://tail-f.com/ned/cisco-ios-xr">
           <GigabitEthernet>
             <id>0/0</id>
             <ipv4>
               <access-group>
                 <direction>ingress</direction>
                 <name>ACL_CLUS</name>
               </access-group>
             </ipv4>
           </GigabitEthernet>
         </interface>

         <configuration xmlns="http://xml.juniper.net/xnm/1.1/xnm">
           <interfaces>
             <interface>
               <name>xe-0/0/0</name>
               <unit>
                 <name>0</name>
                 <family>
                   <inet>
                     <filter>
                       <input>
                         <filter-name>ACL_CLUS</filter-name>
                       </input>
                     </filter>
                   </inet>
                 </family>
               </unit>
             </interface>
           </interfaces>
           <firewall>
             <family>
               <inet>
                 <filter>
                   <name>ACL_CLUS</name>
                   <term>
                     <name>10</name>
                     <from>
                       <source-address>
                         <name>172.16.0.0/16</name>
                       </source-address>
                     </from>
                     <then>
                       <accept/>
                     </then>
                   </term>
                   <term>
                     <name>20</name>
                     <from>
                       <source-address>
                         <name>192.168.34.0/24</name>
                       </source-address>
                     </from>
                     <then>
                       <reject/>
                     </then>
                   </term>
                 </filter>
               </inet>
             </family>
           </firewall>
         </configuration>

       </config>
     </device>
   </devices>
 </config-template>
```
Congratz! You have prepared all devices configuration! But it's now fixed. Let's put our **variables** here!

```
<config-template xmlns="http://tail-f.com/ns/config/1.0">
  <devices xmlns="http://tail-f.com/ns/ncs">
    <device>
      <!--
          Select the devices from some data structure in the service
          model. In this skeleton the devices are specified in a leaf-list.
          Select all devices in that leaf-list:
        -->
        <name>{/device}</name>
        <config>
         <ip xmlns="urn:ios">
           <access-list>
             <standard>
               <std-named-acl>
                 <name>ACL_CLUS</name>
                 <std-access-list-rule>
                   <rule>permit 172.16.0.0 0.0.255.255</rule>
                 </std-access-list-rule>
                 <std-access-list-rule>
                   <rule>deny 192.168.34.0 0.0.0.255</rule>
                 </std-access-list-rule>
               </std-named-acl>
             </standard>
           </access-list>
         </ip>
         <interface xmlns="urn:ios">
           <GigabitEthernet>
             <name>{/ios/interface}</name>
             <ip>
               <access-group>
                 <direction>{/ios/direction}</direction>
                 <access-list>ACL_CLUS</access-list>
               </access-group>
             </ip>
           </GigabitEthernet>
         </interface>

         <ipv4 xmlns="http://tail-f.com/ned/cisco-ios-xr">
           <access-list>
             <named-acl>
               <name>ACL_CLUS</name>
               <rule>
                 <id>10</id>
                 <line>permit 172.16.0.0 0.0.255.255</line>
               </rule>
               <rule>
                 <id>20</id>
                 <line>deny 192.168.34.0 0.0.0.255</line>
               </rule>
             </named-acl>
           </access-list>
         </ipv4>
         <interface xmlns="http://tail-f.com/ned/cisco-ios-xr">
           <GigabitEthernet>
             <id>{/xr/interface}</id>
             <ipv4>
               <access-group>
                 <direction>{/xr/direction}</direction>
                 <name>ACL_CLUS</name>
               </access-group>
             </ipv4>
           </GigabitEthernet>
         </interface>

         <configuration xmlns="http://xml.juniper.net/xnm/1.1/xnm">
           <interfaces>
             <interface>
               <name>{/junos/interface}</name>
               <unit>
                 <name>0</name>
                 <family>
                   <inet>
                     <filter>
                       <input when="{/junos/direction='input'}">
                         <filter-name>ACL_CLUS</filter-name>
                       </input>
                       <output when="{/junos/direction='output'}">
                         <filter-name>ACL_CLUS</filter-name>
                       </output>
                     </filter>
                   </inet>
                 </family>
               </unit>
             </interface>
           </interfaces>
           <firewall>
             <family>
               <inet>
                 <filter>
                   <name>ACL_CLUS</name>
                   <term>
                     <name>10</name>
                     <from>
                       <source-address>
                         <name>172.16.0.0/16</name>
                       </source-address>
                     </from>
                     <then>
                       <accept/>
                     </then>
                   </term>
                   <term>
                     <name>20</name>
                     <from>
                       <source-address>
                         <name>192.168.34.0/24</name>
                       </source-address>
                     </from>
                     <then>
                       <reject/>
                     </then>
                   </term>
                 </filter>
               </inet>
             </family>
           </firewall>
         </configuration>

       </config>
     </device>
   </devices>
 </config-template>

```

### 3rd step - Create YANG DATA MODEL

Second part is a YANG Data Model of our Service - this will give us an opportunity to provide the CLI interface to configure our Service exactly in that way that we want to have. 
```
/ncs-run/packages
├── ACL_SERVICE
    └── src
        ├── yang
        │   └── ACL_SERVICE.yang
        └── Makefile
```
Hmmm... what was our Service design from the previous Chapter?
```
service ACL_SERVICE [device] [interface] [in|out]
```

Let's model it in YANG! <br>
This is our generated YANG Skeleton:
```
module ACL_SERVICE {

  namespace "http://example.com/ACL_SERVICE";
  prefix ACL_SERVICE;

  import ietf-inet-types {
    prefix inet;
  }
  import tailf-common {
    prefix tailf;
  }
  import tailf-ncs {
    prefix ncs;
  }

  description
    "Bla bla...";

  revision 2016-01-01 {
    description
      "Initial revision.";
  }

  list ACL_SERVICE {
    description "This is an RFS skeleton service";

    key name;
    leaf name {
      tailf:info "Unique service id";
      tailf:cli-allow-range;
      type string;
    }

    uses ncs:service-data;
    ncs:servicepoint ACL_SERVICE-servicepoint;

    // may replace this with other ways of refering to the devices.
    leaf-list device {
      type leafref {
        path "/ncs:devices/ncs:device/ncs:name";
      }
    }

    // replace with your own stuff here
    leaf dummy {
      type inet:ipv4-address;
    }
  }
}
```

Let's make some changes:
```
module ACL_SERVICE {

  namespace "http://example.com/ACL_SERVICE";
  prefix ACL_SERVICE;

  import ietf-inet-types {
    prefix inet;
  }
  import tailf-common {
    prefix tailf;
  }
  import tailf-ncs {
    prefix ncs;
  }
  import tailf-ned-cisco-ios {
    prefix ios;
  }
  import tailf-ned-cisco-ios-xr {
    prefix iosxr;
  }
  import junos {
    prefix junos;
  }

  description
    "Bla bla...";

  revision 2016-01-01 {
    description
      "Initial revision.";
  }

  list ACL_SERVICE {
    description "This is an RFS skeleton service";

    key "device";
    uses ncs:service-data;
    ncs:servicepoint ACL_SERVICE-servicepoint;

    leaf device {
      type leafref {
        path "/ncs:devices/ncs:device/ncs:name";
      }
    }

    container ios {
        tailf:cli-drop-node-name;
        when "(contains(deref(../device)/../ncs:platform/ncs:name, 'ios'))" {
        tailf:dependency "../device";
        }
        leaf interface {
        type leafref {
          path "deref(../../device)/../ncs:config/ios:interface/ios:GigabitEthernet/ios:name";
          }
        }
        leaf direction {
          type enumeration { 
            enum in; 
            enum out; 
          }
        }
    }

      container xr {
        tailf:cli-drop-node-name;
        when "(contains(deref(../device)/../ncs:platform/ncs:name, 'ios-xr'))" {
        tailf:dependency "../device";
        }
        leaf interface {
        type leafref {
          path "deref(../../device)/../ncs:config/iosxr:interface/iosxr:GigabitEthernet/iosxr:id";
          }
        }
        leaf direction {
          type enumeration { 
            enum in; 
            enum out; 
          }
        }
      }

      container junos {
        tailf:cli-drop-node-name;
        when "(contains(deref(../device)/../ncs:platform/ncs:name, 'junos'))" {
        tailf:dependency "../device";
        }
        leaf interface {
        type leafref {
          path "deref(../../device)/../ncs:config/junos:configuration/junos:interfaces/junos:interface/junos:name";
          }
        }
        leaf direction {
          type enumeration { 
            enum input; 
            enum output; 
          }
        }
      }

  }
}
```

After creation of the model, go back to the ACL_SERVICE folder and compile the package executing command:
```
make clean all
```

### 4th step - Create PYTHON LOGIC (optional)

Third part is a Python code of our Service - this will give us an opportunity to provide logic to our Service if we need to calculate something before appending to the template or provide some data to configure from 3rd party.
```
/ncs-run/packages
├── ACL_SERVICE
    └── python
        └── ACL_SERVICE
            ├── main.py
            └── __init__.py
```
---
<h4 align="center">[6/9]</h4>
<h4 align="center"> <a href="/readme/4.md"> :arrow_left: Design the Service! </a> || <a href="/readme/6.md"> Deploy the Service! :arrow_right: </a> </h4>
